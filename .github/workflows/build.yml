name: Selcukes CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        java: [ 17, 21 ]

    steps:
      # Pin to immutable SHA to prevent supply chain attacks via compromised tags
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Mask ALL secrets before any step can accidentally expose them
      - name: Mask secrets
        run: |
          echo "::add-mask::${{ secrets.SONAR_TOKEN }}"
          echo "::add-mask::${{ secrets.BROWSERSTACK_USERNAME }}"
          echo "::add-mask::${{ secrets.BROWSERSTACK_ACCESS_KEY }}"

      # setup-java auto-generates ~/.m2/settings.xml with BrowserStack credentials.
      # server-username and server-password are env var NAMES (not values),
      # which Maven resolves at runtime — secrets never appear in any file or log.
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ matrix.java }}
          server-id: browserstack
          server-username: BROWSERSTACK_USERNAME
          server-password: BROWSERSTACK_ACCESS_KEY

      # Verify GPG key fingerprint before trusting; fail loudly on mismatch or HTTP error
      - name: Install Edge on Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc -o microsoft.asc
          FINGERPRINT=$(gpg --with-colons --import-options show-only --import microsoft.asc \
            | awk -F: '/^fpr/ { print $10; exit }')
          EXPECTED="BC528686B50D79E339D3721CEB3E94ADBE1229CF"
          if [ "$FINGERPRINT" != "$EXPECTED" ]; then
            echo "ERROR: GPG key fingerprint mismatch! Got $FINGERPRINT, expected $EXPECTED"
            rm -f microsoft.asc
            exit 1
          fi
          gpg --dearmor < microsoft.asc > microsoft.gpg
          sudo install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" \
            > /etc/apt/sources.list.d/microsoft-edge-dev.list'
          rm -f microsoft.asc microsoft.gpg
          sudo apt-get update -q && sudo apt-get install -y microsoft-edge-beta

      - name: Cache SonarCloud packages
        uses: actions/cache@v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v5
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # Secrets passed as env vars — Maven resolves them via the auto-generated
      # settings.xml produced by setup-java above. Nothing passed as CLI -D argument.
      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          mvn -B \
            -DtrimStackTrace=true \
            -q verify \
            org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=selcukes_selcukes-java
